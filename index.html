<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Relay Control Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.3.4/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:  linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #ffffff;
            padding: 25px;
            border-radius: 15px;
            box-shadow:  0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 2em;
            font-weight: 700;
        }

        . status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .status-dot {
            width: 15px;
            height: 15px;
            border-radius:  50%;
            animation: pulse 2s infinite;
        }

        . status-dot.online {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status-dot.offline {
            background: #dc3545;
            box-shadow: 0 0 10px #dc3545;
            animation: none;
        }

        .status-dot.connecting {
            background: #ffc107;
            box-shadow:  0 0 10px #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .relay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .relay-card {
            background: white;
            padding: 25px;
            border-radius:  15px;
            box-shadow:  0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .relay-card:hover {
            transform: translateY(-5px);
            box-shadow:  0 10px 25px rgba(0,0,0,0.15);
        }

        .relay-card.all-off-card {
            grid-column: 1 / -1;
            background: white;
            padding: 40px;
            border:  3px solid #dc3545;
        }

        .relay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .relay-name {
            font-size: 1.3em;
            font-weight:  700;
            color: #333;
        }

        .all-off-card . relay-name {
            color:  #dc3545;
            font-size: 1.8em;
        }

        .relay-state {
            padding: 5px 15px;
            border-radius:  20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .relay-state.on {
            background: #28a745;
            color: white;
        }

        .relay-state.off {
            background: #6c757d;
            color:  white;
        }

        . relay-state.unknown {
            background: #ffc107;
            color: #333;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding:  12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* RELAY BUTTONS - Hidden when disabled */
        button.on-btn,
        button.off-btn {
            background: #28a745;
            color: white;
        }

        button.on-btn: hover,
        button.off-btn:hover {
            background: #218838;
        }

        button.on-btn:disabled,
        button.off-btn:disabled {
            display: none;
        }

        button.off-btn {
            background: #6c757d;
            color:  white;
        }

        button.off-btn:hover {
            background: #545b62;
        }

        /* ALL OFF BUTTON - Toggle style */
        button.all-off-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            width: 100%;
            font-weight: 700;
            border: 2px solid #dc3545;
            background: white;
            color: #dc3545;
        }

        button.all-off-btn:hover: not(:disabled) {
            transform: scale(1.05);
        }

        /* ALL OFF Button - ACTIVE State (Red/Filled) */
        button.all-off-btn.active {
            background: #dc3545;
            color: white;
            border:  2px solid #dc3545;
        }

        button.all-off-btn.active:hover {
            background: #c82333;
            border-color: #c82333;
        }

        /* ALL OFF Button - INACTIVE State (Hollow) */
        button.all-off-btn: not(. active) {
            background: white;
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        button.all-off-btn:not(.active):hover:not(:disabled) {
            background: #fff0f0;
        }

        button.all-off-btn:disabled {
            background: #cccccc;
            color: #666666;
            border-color: #999999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        . all-off-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .all-off-indicator {
            width: 12px;
            height: 12px;
            border-radius:  50%;
            background: #cccccc;
            animation: none;
        }

        .all-off-indicator.active {
            background: #dc3545;
            box-shadow:  0 0 8px #dc3545;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        . footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            font-size: 0.9em;
        }

        . debug-info {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius:  5px;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”Œ ESP32 Relay Control Dashboard</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot connecting" id="statusDot"></div>
                    <span id="statusText">Connecting to MQTT...</span>
                </div>
            </div>
        </div>

        <div class="relay-grid" id="relayGrid">
            <!-- Relay cards will be generated here -->
        </div>

        <div class="footer">
            <div>ESP32 MQTT Relay Control System | Innovation Lab ECB EICE</div>
            <div class="debug-info" id="debugInfo">Initializing...</div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_TOPIC = 'smart_innovation_lab_ecb_eice';
        const RELAY_COUNT = 8;
        
        // MQTT Configuration
        const MQTT_BROKERS = [
            'wss://broker.emqx.io:8084/mqtt',
            'ws://broker.emqx.io:8083/mqtt'
        ];
        let currentBrokerIndex = 0;
        const CLIENT_ID = 'WebDashboard_' + Math.random().toString(16).substr(2, 8);
        
        // State
        let mqttClient = null;
        let deviceOnline = false;
        let relayStates = {};
        let brokerConnected = false;
        let allOffActive = false;
        
        // Initialize relay states as unknown
        for (let i = 1; i <= RELAY_COUNT; i++) {
            relayStates[i] = '? ';
        }
        
        // Debug logging
        function debugLog(msg) {
            console.log(msg);
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.textContent = `[${timestamp}] ${msg}`;
            }
        }
        
        // Generate relay cards
        function generateRelayCards() {
            const grid = document.getElementById('relayGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= RELAY_COUNT; i++) {
                const card = document.createElement('div');
                card.className = 'relay-card';
                card.innerHTML = `
                    <div class="relay-header">
                        <div class="relay-name">Relay ${i}</div>
                        <div class="relay-state unknown" id="state${i}">?</div>
                    </div>
                    <div class="button-group">
                        <button class="on-btn" id="onBtn${i}" onclick="sendRelayCommand(${i}, 'ON')">
                            ON
                        </button>
                        <button class="off-btn" id="offBtn${i}" onclick="sendRelayCommand(${i}, 'OFF')">
                            OFF
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            }

            // Add ALL OFF card at the end
            const allOffCard = document.createElement('div');
            allOffCard.className = 'relay-card all-off-card';
            allOffCard. innerHTML = `
                <div class="all-off-status">
                    <div class="all-off-indicator" id="allOffIndicator"></div>
                    <span>ALL OFF Status</span>
                </div>
                <div class="button-group">
                    <button class="all-off-btn" id="allOffBtn" onclick="toggleAllOff()">
                        ALL OFF
                    </button>
                </div>
            `;
            grid.appendChild(allOffCard);
        }
        
        // Update UI based on connection and device status
        function updateStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (! brokerConnected) {
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'Connecting to MQTT...';
            } else if (deviceOnline) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'ESP32 Online';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ESP32 Offline';
            }
            
            updateRelayButtons();
        }
        
        // Update relay buttons based on device status
        function updateRelayButtons() {
            for (let i = 1; i <= RELAY_COUNT; i++) {
                const onBtn = document.getElementById(`onBtn${i}`);
                const offBtn = document.getElementById(`offBtn${i}`);
                
                if (brokerConnected && deviceOnline) {
                    onBtn.disabled = false;
                    offBtn.disabled = false;
                } else {
                    onBtn.disabled = true;
                    offBtn. disabled = true;
                }
            }

            // ALL OFF button - only enable if broker is connected
            const allOffBtn = document. getElementById('allOffBtn');
            if (brokerConnected) {
                allOffBtn.disabled = false;
            } else {
                allOffBtn. disabled = true;
            }
        }
        
        // Update relay state display
        function updateRelayState(relayNum, state) {
            relayStates[relayNum] = state;
            const stateElement = document.getElementById(`state${relayNum}`);
            
            if (state === 'ON') {
                stateElement. textContent = 'ON';
                stateElement.className = 'relay-state on';
            } else if (state === 'OFF') {
                stateElement.textContent = 'OFF';
                stateElement.className = 'relay-state off';
            } else {
                stateElement.textContent = '?';
                stateElement. className = 'relay-state unknown';
            }
        }

        // Update ALL OFF button appearance
        function updateAllOffButton() {
            const allOffBtn = document.getElementById('allOffBtn');
            const allOffIndicator = document.getElementById('allOffIndicator');
            
            if (allOffActive) {
                allOffBtn. classList.add('active');
                allOffIndicator.classList.add('active');
                allOffBtn.textContent = 'âš ï¸ ALL OFF:  ON';
            } else {
                allOffBtn.classList.remove('active');
                allOffIndicator.classList. remove('active');
                allOffBtn.textContent = 'ALL OFF';
            }
        }
        
        // Send relay command
        function sendRelayCommand(relayNum, command) {
            if (!brokerConnected) {
                alert('Not connected to MQTT broker');
                return;
            }
            
            if (! deviceOnline) {
                alert('Cannot control relays while ESP32 is offline');
                return;
            }
            
            const topic = `${BASE_TOPIC}/relay/${relayNum}/cmd`;
            mqttClient.publish(topic, command, { qos: 0, retain: false }, (err) => {
                if (err) {
                    console.error('Failed to send command:', err);
                    debugLog(`Error:  Failed to send ${command} to Relay ${relayNum}`);
                } else {
                    debugLog(`Sent ${command} to Relay ${relayNum}`);
                }
            });
        }
        
        // Toggle ALL OFF command
        function toggleAllOff() {
            if (! brokerConnected) {
                alert('Not connected to MQTT broker');
                return;
            }
            
            const topic = `${BASE_TOPIC}/system/all`;
            
            if (allOffActive) {
                // Turn OFF ALL OFF - send empty string
                mqttClient.publish(topic, '', { qos: 0, retain: true }, (err) => {
                    if (err) {
                        console.error('Failed to clear ALL_OFF:', err);
                        debugLog('Error: Failed to clear ALL_OFF');
                    } else {
                        allOffActive = false;
                        updateAllOffButton();
                        debugLog('ALL OFF cleared (sent empty string)');
                    }
                });
            } else {
                // Turn ON ALL OFF - send ALL_OFF command
                mqttClient. publish(topic, 'ALL_OFF', { qos: 0, retain: true }, (err) => {
                    if (err) {
                        console.error('Failed to send ALL_OFF:', err);
                        debugLog('Error: Failed to send ALL_OFF');
                    } else {
                        allOffActive = true;
                        updateAllOffButton();
                        debugLog('ALL OFF activated (sent ALL_OFF)');
                    }
                });
            }
        }
        
        // Connect to MQTT broker
        function connectMQTT() {
            const brokerUrl = MQTT_BROKERS[currentBrokerIndex];
            debugLog(`Attempting to connect to:  ${brokerUrl}`);
            
            mqttClient = mqtt.connect(brokerUrl, {
                clientId: CLIENT_ID,
                clean: true,
                reconnectPeriod: 5000,
                connectTimeout: 10000
            });
            
            mqttClient.on('connect', () => {
                debugLog(`Connected to MQTT broker:  ${brokerUrl}`);
                brokerConnected = true;
                updateStatus();
                
                // Subscribe to device status
                mqttClient.subscribe(`${BASE_TOPIC}/device/status`, { qos: 0 }, (err) => {
                    if (! err) {
                        debugLog('Subscribed to device/status');
                    }
                });
                
                // Subscribe to relay states
                mqttClient. subscribe(`${BASE_TOPIC}/relay/+/state`, { qos: 0 }, (err) => {
                    if (!err) {
                        debugLog('Subscribed to relay states');
                    }
                });

                // Subscribe to system/all to track ALL OFF state
                mqttClient. subscribe(`${BASE_TOPIC}/system/all`, { qos: 0 }, (err) => {
                    if (!err) {
                        debugLog('Subscribed to system/all');
                    }
                });
            });
            
            mqttClient.on('message', (topic, message) => {
                const msg = message.toString();
                debugLog(`Received: ${topic} = ${msg}`);
                
                // Device status
                if (topic === `${BASE_TOPIC}/device/status`) {
                    deviceOnline = (msg === 'online');
                    updateStatus();
                    debugLog(`ESP32 Status: ${deviceOnline ? 'ONLINE' : 'OFFLINE'}`);
                    
                    // If device goes offline, set all relay states to unknown
                    if (!deviceOnline) {
                        for (let i = 1; i <= RELAY_COUNT; i++) {
                            updateRelayState(i, '? ');
                        }
                    }
                }
                
                // Relay state updates
                const relayMatch = topic.match(/\/relay\/(\d+)\/state/);
                if (relayMatch) {
                    const relayNum = parseInt(relayMatch[1]);
                    updateRelayState(relayNum, msg);
                }

                // ALL OFF state updates
                if (topic === `${BASE_TOPIC}/system/all`) {
                    allOffActive = (msg === 'ALL_OFF');
                    updateAllOffButton();
                    debugLog(`ALL OFF State: ${allOffActive ? 'ACTIVE' : 'INACTIVE'}`);
                }
            });
            
            mqttClient. on('error', (err) => {
                console.error('MQTT error:', err);
                debugLog(`MQTT Error: ${err.message}`);
                brokerConnected = false;
                updateStatus();
                
                // Try next broker
                if (currentBrokerIndex < MQTT_BROKERS.length - 1) {
                    currentBrokerIndex++;
                    debugLog('Trying alternative broker...');
                    setTimeout(() => {
                        if (mqttClient) {
                            mqttClient.end(true);
                        }
                        connectMQTT();
                    }, 2000);
                }
            });
            
            mqttClient.on('offline', () => {
                debugLog('MQTT client offline');
                brokerConnected = false;
                updateStatus();
            });
            
            mqttClient.on('reconnect', () => {
                debugLog('Reconnecting to MQTT broker...');
            });
            
            mqttClient.on('close', () => {
                debugLog('Connection closed');
                brokerConnected = false;
                updateStatus();
            });
        }
        
        // Initialize
        window. addEventListener('load', () => {
            debugLog('Dashboard loaded, initializing...');
            generateRelayCards();
            connectMQTT();
        });
    </script>
</body>
</html>
