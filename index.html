<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Smart Relay Control</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .status {
      text-align: center;
      font-size: 20px;
      margin-bottom: 20px;
    }

    .online { color: #00ff00; }
    .offline { color: #ff4444; }

    .relay {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #222;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
    }

    .switch {
      position: relative;
      width: 50px;
      height: 26px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #555;
      border-radius: 26px;
      transition: 0.3s;
    }

    .slider:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    input:checked + .slider {
      background: #00cc66;
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    input:disabled + .slider {
      background: #333;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h1>ESP32 Smart Innovation Lab</h1>

<div id="status" class="status offline">ESP32 OFFLINE</div>

<div id="relays"></div>

<script>
/* ================= MQTT CONFIG ================= */
const broker = "wss://broker.emqx.io:8084/mqtt";
const baseTopic = "smart_innovation_lab_ecb_eice";

/* ================= STATE ================= */
let espOnline = false;

/* ================= MQTT CONNECT ================= */
const client = mqtt.connect(broker);

client.on("connect", () => {
  console.log("Connected to MQTT broker");

  client.subscribe(`${baseTopic}/status/online`);
  client.subscribe(`${baseTopic}/relay/+/state`);
});

/* ================= MQTT MESSAGE ================= */
client.on("message", (topic, payload) => {
  const msg = payload.toString();

  if (topic === `${baseTopic}/status/online`) {
    espOnline = (msg === "ONLINE");
    updateStatus();
    setAllSwitchEnable(espOnline);
    return;
  }

  const match = topic.match(/relay\/(\d+)\/state/);
  if (match) {
    const index = parseInt(match[1]) - 1;
    const checkbox = document.getElementById(`relay${index}`);
    if (checkbox) checkbox.checked = (msg === "ON");
  }
});

/* ================= UI FUNCTIONS ================= */
function updateStatus() {
  const status = document.getElementById("status");
  if (espOnline) {
    status.textContent = "ESP32 ONLINE";
    status.className = "status online";
  } else {
    status.textContent = "ESP32 OFFLINE";
    status.className = "status offline";
  }
}

function setAllSwitchEnable(enable) {
  for (let i = 0; i < 8; i++) {
    document.getElementById(`relay${i}`).disabled = !enable;
  }
}

function sendRelayCommand(index, state) {
  if (!espOnline) return;
  const topic = `${baseTopic}/relay/${index + 1}/set`;
  client.publish(topic, state ? "ON" : "OFF");
}

/* ================= BUILD UI ================= */
const relayContainer = document.getElementById("relays");

for (let i = 0; i < 8; i++) {
  const div = document.createElement("div");
  div.className = "relay";

  div.innerHTML = `
    <span>Relay ${i + 1}</span>
    <label class="switch">
      <input type="checkbox" id="relay${i}" disabled>
      <span class="slider"></span>
    </label>
  `;

  relayContainer.appendChild(div);

  document.getElementById(`relay${i}`).addEventListener("change", (e) => {
    sendRelayCommand(i, e.target.checked);
  });
}
</script>

</body>
</html>
