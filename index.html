<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Relay Control Dashboard</title>

  <!-- MQTT.js CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.3);
    }

    h1 {
      margin: 0;
      font-size: 24px;
    }

    .status {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
    }

    .online {
      background: #00c853;
    }

    .offline {
      background: #d50000;
    }

    .container {
      padding: 30px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }

    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card.ON {
      border: 2px solid #00e676;
    }

    .card.OFF {
      border: 2px solid #ff5252;
    }

    .card h3 {
      margin-top: 0;
    }

    .card p {
      margin: 10px 0;
    }

    button {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .on-btn {
      background: #ff5252;
      color: white;
    }

    .off-btn {
      background: #00e676;
      color: black;
    }

    button:disabled {
      background: gray;
      cursor: not-allowed;
    }

    .footer {
      margin-top: 40px;
      text-align: center;
    }

    .alloff {
      padding: 15px 40px;
      font-size: 18px;
      background: linear-gradient(45deg, #ff1744, #d50000);
      color: white;
      border-radius: 30px;
      box-shadow: 0 10px 30px rgba(255,0,0,0.4);
    }
  </style>
</head>

<body>

<header>
  <h1>Smart Relay Control Panel</h1>
  <div id="deviceStatus" class="status offline">ðŸ”´ OFFLINE</div>
</header>

<div class="container">
  <div class="grid" id="relayGrid"></div>

  <div class="footer">
    <button id="allOffBtn" class="alloff" disabled>ðŸš¨ ALL OFF</button>
  </div>
</div>

<script>
  const BROKER_URL = "wss://broker.emqx.io:8084/mqtt";
  const BASE_TOPIC = "smart_innovation_lab_ecb_eice";

  const relayNames = [
    "LED 1","LED 2","LED 3","LED 4",
    "LED 5","LED 6","LED 7","LED 8"
  ];

  const relayStates = Array(8).fill("OFF");

  const grid = document.getElementById("relayGrid");
  const statusDiv = document.getElementById("deviceStatus");
  const allOffBtn = document.getElementById("allOffBtn");

  // Create relay cards
  relayNames.forEach((name, i) => {
    const card = document.createElement("div");
    card.className = "card OFF";
    card.id = `relay-${i}`;

    card.innerHTML = `
      <h3>${name}</h3>
      <p id="state-${i}">Status: OFF</p>
      <button id="btn-${i}" class="off-btn">TURN ON</button>
    `;

    grid.appendChild(card);

    document.getElementById(`btn-${i}`).onclick = () => toggleRelay(i);
  });

  // MQTT connection
  const client = mqtt.connect(BROKER_URL);

  client.on("connect", () => {
    console.log("MQTT connected");

    client.subscribe(`${BASE_TOPIC}/device/status`);
    for (let i = 1; i <= 8; i++) {
      client.subscribe(`${BASE_TOPIC}/relay/${i}/state`);
    }
  });

  client.on("message", (topic, payload) => {
    const msg = payload.toString();

    // Device status
    if (topic.endsWith("/device/status")) {
      if (msg === "online") {
        statusDiv.textContent = "ðŸŸ¢ ONLINE";
        statusDiv.className = "status online";
        allOffBtn.disabled = false;
        enableButtons(true);
      } else {
        statusDiv.textContent = "ðŸ”´ OFFLINE";
        statusDiv.className = "status offline";
        allOffBtn.disabled = true;
        enableButtons(false);
      }
    }

    // Relay states
    for (let i = 1; i <= 8; i++) {
      if (topic === `${BASE_TOPIC}/relay/${i}/state`) {
        updateRelay(i - 1, msg);

        // Clear retained ALL_OFF if any relay turns ON
        if (msg === "ON") {
          client.publish(`${BASE_TOPIC}/system/all`, "", { retain: true });
        }
      }
    }
  });

  function toggleRelay(index) {
    if (!client.connected) return;
    const cmd = relayStates[index] === "ON" ? "OFF" : "ON";
    client.publish(`${BASE_TOPIC}/relay/${index + 1}/cmd`, cmd);
  }

  function updateRelay(index, state) {
    relayStates[index] = state;

    const card = document.getElementById(`relay-${index}`);
    const text = document.getElementById(`state-${index}`);
    const btn = document.getElementById(`btn-${index}`);

    card.className = `card ${state}`;
    text.textContent = `Status: ${state}`;

    if (state === "ON") {
      btn.textContent = "TURN OFF";
      btn.className = "on-btn";
    } else {
      btn.textContent = "TURN ON";
      btn.className = "off-btn";
    }
  }

  function enableButtons(enable) {
    for (let i = 0; i < 8; i++) {
      document.getElementById(`btn-${i}`).disabled = !enable;
    }
  }

  allOffBtn.onclick = () => {
    if (!client.connected) return;
    client.publish(`${BASE_TOPIC}/system/all`, "ALL_OFF", { retain: true });
  };
</script>

</body>
</html>
