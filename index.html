<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Smart Innovation Lab</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { font-family: Arial; background:#111; color:#fff; }
button { padding:10px; margin:5px; }
.offline { opacity:0.5; }
</style>
</head>

<body>
<h2>Smart Innovation Lab</h2>
<p id="status">OFFLINE</p>

<div id="relays"></div>

<button onclick="allOff()">ALL OFF</button>

<script>
const BASE = "smart_innovation_lab_ecb_eice";
const client = mqtt.connect("ws://broker.emqx.io:8083/mqtt");

let online = false;

client.on("connect", () => {
  client.subscribe(`${BASE}/#`);
});

client.on("message", (topic, msg) => {
  msg = msg.toString();

  if (topic === `${BASE}/device/status`) {
    online = msg === "online";
    document.getElementById("status").innerText = msg.toUpperCase();
    updateUI();
  }

  if (topic.includes("/state")) {
    const n = topic.match(/relay\/(\d+)/)[1];
    document.getElementById(`r${n}`).innerText = msg;
  }
});

function sendRelay(n, state) {
  if (!online) return;
  client.publish(`${BASE}/relay/${n}/cmd`, state);
}

function allOff() {
  client.publish(`${BASE}/system/all`, "ALL_OFF", { retain:true });
}

function updateUI() {
  document.querySelectorAll(".relayBtn").forEach(b => {
    b.disabled = !online;
  });
}

for (let i=1;i<=8;i++) {
  relays.innerHTML += `
    <div>
      Relay ${i} :
      <button class="relayBtn" onclick="sendRelay(${i},'ON')">ON</button>
      <button class="relayBtn" onclick="sendRelay(${i},'OFF')">OFF</button>
      <span id="r${i}">?</span>
    </div>`;
}
</script>
</body>
</html>
